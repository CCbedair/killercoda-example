#!/bin/bash

echo -e "
  _  __     _                          _            
 | |/ /    | |                        | |           
 | ' /_   _| |__   ___ _ __ _ __   ___| |_ ___  ___ 
 |  <| | | | '_ \ / _ \ '__| '_ \ / _ \ __/ _ \/ __|
 | . \ |_| | |_) |  __/ |  | | | |  __/ ||  __/\__ \
 |_|\_\__,_|_.__/ \___|_|  |_| |_|\___|\__\___||___/
                   | |                              
   __ _  ___   __ _| |_                             
  / _` |/ _ \ / _` | __|                            
 | (_| | (_) | (_| | |_                             
  \__, |\___/ \__,_|\__|                            
   __/ |                                            
  |___/ 
" > kubegoat

# Apply DIND deployment https://github.com/madhuakula/kubernetes-goat/blob/master/access-kubernetes-goat.sh#L22
APP_NAME="health-check"
APP_PORT=80
git clone https://github.com/madhuakula/kubernetes-goat.git
kubectl apply -f kubernetes-goat/scenarios/$APP_NAME/deployment.yaml
rm -rf kubernetes-goat

sleep 15

# Exposing the port
POD_NAME=$(kubectl get pods --all-namespaces -l "app=$APP_NAME" -o jsonpath="{.items[0].metadata.name}")
NAMESPACE=$(kubectl get pods --all-namespaces -l "app=$APP_NAME" -o jsonpath="{.items[0].metadata.namespace}")
kubectl port-forward $POD_NAME -n $NAMESPACE --address 0.0.0.0 1234:$APP_PORT > /dev/null 2>&1 &

echo done > /tmp/background0